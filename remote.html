<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Karaoke Remote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { margin:0; font-family:sans-serif; background:#1a1a1a; color:#fff; display:flex; height:100vh; }
#left { width:45%; padding:20px; background:#2a2a2a; overflow-y:auto; }
#right { width:55%; padding:20px; background:#1a1a1a; overflow-y:auto; }
h2 { margin-bottom:15px; color:#ff3b3f; border-bottom:2px solid #ff3b3f; padding-bottom:5px; }
input { width:70%; padding:10px; border:none; border-radius:5px 0 0 5px; font-size:16px; outline:none; }
button { padding:10px; border:none; background:#ff3b3f; color:white; border-radius:0 5px 5px 0; cursor:pointer; margin-left:5px; transition:0.2s; }
button:hover { background:#e52a2f; }
.item { display:flex; align-items:center; margin-top:10px; background:#333; padding:8px; border-radius:6px; cursor:pointer; transition:0.2s; }
.item:hover { background:#444; }
.item img { width:80px; height:60px; object-fit:cover; margin-right:12px; border-radius:6px; }
.title { font-size:0.95em; line-height:1.2em; flex:1; color:#fff; }
#status { margin-top:10px; color:#aaa; font-size:0.9em; }
.song-list .song-item { display:flex; align-items:center; justify-content:space-between; background:#333; padding:8px; margin-top:6px; border-radius:6px; transition:0.2s; }
.song-list .song-item:hover { background:#444; }
.song-list button { margin-left:4px; padding:6px 8px; font-size:0.85em; background:#ff3b3f; border:none; border-radius:4px; cursor:pointer; transition:0.2s; }
.song-list button:hover { background:#e52a2f; }
.switch { display:flex; align-items:center; margin-top:10px; }
.switch input { margin-right:6px; }
input[type=range] { width:100%; margin-top:5px; accent-color:#ff3b3f; }
.control-buttons { display:flex; gap:10px; margin-top:15px; }
.control-buttons button { flex:1; padding:10px; font-weight:bold; }
</style>
</head>
<body>

<div id="left">
  <h2>üé§ T√¨m b√†i</h2>
  <input id="q" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
  <button onclick="search()">T√¨m</button>
  <div class="switch">
    <input type="checkbox" id="karaokeOnly" checked />
    <label for="karaokeOnly">Ch·ªâ Karaoke</label>
  </div>
  <div id="status"></div>
  <div id="list"></div>
</div>

<div id="right">
  <h2>üé¨ Danh s√°ch ph√°t</h2>
  <div class="song-list" id="queue"></div>
  
  <div class="control-buttons">
    <button id="muteBtn">üîá T·∫Øt/B·∫≠t √¢m thanh</button>
    <button id="stopBtn">‚èπÔ∏è D·ª´ng b√†i / Intro</button>
  </div>

  <div style="margin-top:15px;">
    <label>üîä √Çm l∆∞·ª£ng: </label>
    <input type="range" min="0" max="100" value="100" id="volumeSlider">
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, query, orderByKey, limitToFirst } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = { 
    apiKey: "AIzaSyC1JW_dg-YChaizarbS-7UUN3njFomMPvI",
  authDomain: "karaokeweb-d414b.firebaseapp.com",
  databaseURL: "https://karaokeweb-d414b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "karaokeweb-d414b",
  storageBucket: "karaokeweb-d414b.firebasestorage.app",
  messagingSenderId: "183555717781",
  appId: "1:183555717781:web:d3920b342c5d27e107f99c",
  measurementId: "G-VZ228HB7GF"
};

const API_KEY = "AIzaSyALYcXF9pG01RbeCx6DaZADNwNro2NKq4I";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const commandRef = ref(db,"command");
const queueRef = ref(db,"queue");

const listEl = document.getElementById("list");
const statusEl = document.getElementById("status");
const queueEl = document.getElementById("queue");
const muteBtn = document.getElementById("muteBtn");
const stopBtn = document.getElementById("stopBtn");
const volumeSlider = document.getElementById("volumeSlider");

let muteState = false;

// T√¨m b√†i
async function search(){
  const q = document.getElementById("q").value.trim();
  const karaokeOnly = document.getElementById("karaokeOnly").checked;
  if(!q) return alert("Nh·∫≠p t·ª´ kh√≥a!");
  listEl.innerHTML = "";
  statusEl.textContent="üîç ƒêang t√¨m ki·∫øm...";
  try{
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=12&q=${encodeURIComponent(q + (karaokeOnly?" karaoke":""))}&videoEmbeddable=true&key=${API_KEY}`);
    const data = await res.json();
    statusEl.textContent="";
    if(!data.items || data.items.length===0){ statusEl.textContent="Kh√¥ng t√¨m th·∫•y"; return; }
    
    data.items.forEach(v=>{
      if(!v.id?.videoId) return;
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML=`<img src="${v.snippet.thumbnails.medium.url}"><div class="title">${v.snippet.title}</div>`;
      const addBtn=document.createElement("button");
      addBtn.textContent="‚ûï Th√™m b√†i";
      addBtn.onclick=()=> addSong(v.id.videoId, v.snippet.title, v.snippet.thumbnails.medium.url);
      el.appendChild(addBtn);
      listEl.appendChild(el);
    });
  }catch(e){ console.error(e); statusEl.textContent="‚ö†Ô∏è L·ªói t√¨m ki·∫øm"; }
}

function addSong(id, title, thumb){
  push(queueRef,{id,title,thumbnail:thumb});
  // N·∫øu kh√¥ng ƒëang ph√°t b√†i n√†o th√¨ t·ª± ƒë·ªông nh·∫£y
  onValue(commandRef, snapshot=>{
    const cmd = snapshot.val();
    if(!cmd || !cmd.id){ // kh√¥ng c√≥ b√†i ƒëang ph√°t
      set(commandRef,{id,title,play:true,mute:muteState});
    }
  }, {onlyOnce:true});
}

window.search = search;
window.onload = ()=>{ document.getElementById("q").addEventListener("keydown", e=>{ if(e.key==="Enter") search(); }); };

// L·∫Øng nghe queue v√† hi·ªÉn th·ªã danh s√°ch
onValue(queueRef,snapshot=>{
  const val = snapshot.val() || {};
  queueEl.innerHTML="";
  Object.entries(val).forEach(([key,v],index)=>{
    if(!v.id) return;
    const item = document.createElement("div");
    item.className="song-item";
    item.innerHTML=`<div>${v.title}</div>`;

    const playNow = document.createElement("button");
    playNow.textContent="‚è© ∆Øu ti√™n";
    playNow.onclick=()=> {
      set(commandRef,{id:v.id,title:v.title,play:true,mute:muteState});
      remove(ref(db,"queue/"+key));
    };

    const delBtn = document.createElement("button");
    delBtn.textContent="‚ùå X√≥a";
    delBtn.onclick=()=> remove(ref(db,"queue/"+key));

    item.appendChild(playNow);
    item.appendChild(delBtn);
    queueEl.appendChild(item);
  });

  // N·∫øu h·∫øt b√†i, chuy·ªÉn v·ªÅ intro/slide
  onValue(commandRef, snap=>{
    const cmd = snap.val();
    if(cmd && cmd.id===""){ // h·∫øt b√†i
      // T·ª± nh·∫£y b√†i ti·∫øp theo n·∫øu c√≤n
      const firstKey = Object.keys(val)[0];
      if(firstKey){
        const next = val[firstKey];
        set(commandRef,{id:next.id,title:next.title,play:true,mute:muteState});
        remove(ref(db,"queue/"+firstKey));
      }
    }
  }, {onlyOnce:true});
});

// ƒê·ªìng b·ªô remote
onValue(commandRef, snapshot=>{
  const cmd = snapshot.val();
  if(!cmd) return;
  muteBtn.textContent = cmd.mute ? "üîä B·∫≠t √¢m thanh" : "üîá T·∫Øt √¢m thanh";
  volumeSlider.value = cmd.volume ?? 100;
});

// ƒêi·ªÅu khi·ªÉn √¢m thanh
muteBtn.onclick = ()=>{
  muteState = !muteState;
  set(commandRef,{mute:muteState});
};

// TƒÉng/gi·∫£m √¢m l∆∞·ª£ng
volumeSlider.oninput = ()=>{
  set(commandRef,{volume:Number(volumeSlider.value)});
};

// Stop b√†i h√°t, hi·ªán intro/slide thumbnail
stopBtn.onclick = ()=>{
  set(commandRef,{id:"",title:"Intro / Slide",play:false,mute:muteState});
};
</script>
</body>
</html>
