<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Karaoke Remote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { 
  margin:0; 
  font-family:sans-serif; 
  background:#fff; 
  color:#ff3b3f; 
  display:flex; 
  flex-direction:column; 
  height:100vh; 
}
#topBar {
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:15px;
  padding:10px 20px;
  border-bottom:2px solid #ff3b3f;
  font-weight:bold;
}
#topBar button {
  background:#ff3b3f;
  color:#fff;
  border:none;
  padding:6px 12px;
  cursor:pointer;
  border-radius:4px;
  font-weight:bold;
  transition:0.2s;
}
#topBar button:hover { background:#e52a2f; }

#left { 
  flex:1; 
  padding:20px; 
  overflow-y:auto; 
}
h2 { 
  margin-bottom:15px; 
  color:#ff3b3f; 
  border-bottom:2px solid #ff3b3f; 
  padding-bottom:5px; 
}
.search-bar { display:flex; margin-bottom:10px; }
input { 
  flex:1; 
  padding:10px; 
  border:2px solid #ff3b3f; 
  border-radius:5px 0 0 5px; 
  font-size:16px; 
  outline:none; 
}
button.searchBtn { 
  padding:10px 14px; 
  border:none; 
  background:#ff3b3f; 
  color:white; 
  border-radius:0 5px 5px 0; 
  cursor:pointer; 
  font-weight:bold; 
}
button.searchBtn:hover { background:#e52a2f; }

.item { 
  display:flex; 
  align-items:center; 
  margin-top:10px; 
  background:#ffecec; 
  color:#ff3b3f; 
  padding:8px; 
  border-radius:6px; 
  cursor:pointer; 
  transition:0.2s; 
}
.item:hover { background:#ffd6d6; }
.item img { width:80px; height:60px; object-fit:cover; margin-right:12px; border-radius:6px; }
.title { font-size:0.95em; line-height:1.2em; flex:1; color:#ff3b3f; }

#status { margin-top:10px; font-size:0.9em; }
.controls { display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; }
.controls button { flex:1; border-radius:6px; font-size:15px; border:none; background:#ff3b3f; color:#fff; cursor:pointer; }
.controls button:hover { background:#e52a2f; }
#volumeSlider { flex:2; margin-top:10px; }
</style>
</head>
<body>

<div id="topBar">
  <div id="dateTime"></div>
  <div>Ver Web: 1.0</div>
  <button id="refreshBtn">üîÑ Refresh</button>
</div>

<div id="left">
  <h2>üé§ T√¨m b√†i h√°t</h2>
  <div class="search-bar">
    <input id="q" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
    <button class="searchBtn" id="searchBtn">üîç</button>
    <button id="stopBtn">‚èπÔ∏è D·ª´ng</button>
  </div>

  <div style="margin-top:10px;">
    <input type="checkbox" id="karaokeOnly" checked />
    <label for="karaokeOnly">Ch·ªâ Karaoke</label>
  </div>

  <div id="status"></div>
  <div id="list"></div>

  <div class="controls">
    <button id="connectBtn">üîó K·∫øt n·ªëi Room</button>
    <button id="disconnectBtn">‚ùå Ng·∫Øt k·∫øt n·ªëi</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = { 
  apiKey: "AIzaSyC1JW_dg-YChaizarbS-7UUN3njFomMPvI",
  authDomain: "karaokeweb-d414b.firebaseapp.com",
  databaseURL: "https://karaokeweb-d414b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "karaokeweb-d414b",
  storageBucket: "karaokeweb-d414b.appspot.com",
  messagingSenderId: "183555717781",
  appId: "1:183555717781:web:d3920b342c5d27e107f99c",
  measurementId: "G-VZ228HB7GF"
};

const API_KEY = "AIzaSyALYcXF9pG01RbeCx6DaZADNwNro2NKq4I";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const commandRef = ref(db, "command");
const connectionRef = ref(db, "connectionStatus");

const qInput = document.getElementById("q");
const searchBtn = document.getElementById("searchBtn");
const stopBtn = document.getElementById("stopBtn");
const listEl = document.getElementById("list");
const statusEl = document.getElementById("status");
const muteBtn = document.getElementById("muteBtn");
const volumeSlider = document.getElementById("volumeSlider");
const connectBtn = document.getElementById("connectBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
let muteState = false;

// --- Hi·ªÉn th·ªã ng√†y gi·ªù & Refresh ---
const dateTimeEl = document.getElementById("dateTime");
const refreshBtn = document.getElementById("refreshBtn");
function updateDateTime() {
  const now = new Date();
  dateTimeEl.textContent = now.toLocaleString();
}
setInterval(updateDateTime,1000);
updateDateTime();
refreshBtn.onclick = ()=> location.reload();

// --- T√åM KI·∫æM VIDEO ---
async function search() {
  const q = qInput.value.trim();
  const karaokeOnly = document.getElementById("karaokeOnly").checked;
  if (!q) return alert("Nh·∫≠p t·ª´ kh√≥a!");
  listEl.innerHTML = "";
  statusEl.textContent = "üîç ƒêang t√¨m ki·∫øm...";

  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=12&q=${encodeURIComponent(q + (karaokeOnly ? " karaoke" : ""))}&videoEmbeddable=true&key=${API_KEY}`);
    const data = await res.json();
    statusEl.textContent = "";
    if (!data.items || data.items.length === 0) {
      statusEl.textContent = "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.";
      return;
    }
    data.items.forEach(v => {
      if (!v.id?.videoId) return;
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `<img src="${v.snippet.thumbnails.medium.url}"><div class="title">${v.snippet.title}</div>`;
      el.onclick = () => {
        const roomId = localStorage.getItem("roomId");
        if(!roomId){ alert("Ch∆∞a k·∫øt n·ªëi Room!"); return; }
        set(commandRef, { id: v.id.videoId, title: v.snippet.title, play: true, mute: muteState, roomId });
        statusEl.textContent = "‚ñ∂Ô∏è ƒêang ph√°t: " + v.snippet.title;
      };
      listEl.appendChild(el);
    });
  } catch (err) {
    console.error(err);
    statusEl.textContent = "‚ö†Ô∏è L·ªói khi t√¨m ki·∫øm!";
  }
}

// --- ƒêI·ªÄU KHI·ªÇN ---
searchBtn.onclick = search;
qInput.addEventListener("keypress", e => { if (e.key === "Enter") search(); });

stopBtn.onclick = () => {
  const roomId = localStorage.getItem("roomId");
  if(!roomId){ alert("Ch∆∞a k·∫øt n·ªëi Room!"); return; }
  set(commandRef, { id: "", title: "Intro / Slide", play: false, mute: muteState, roomId });
  statusEl.textContent = "‚èπÔ∏è ƒê√£ d·ª´ng ph√°t";
};

muteBtn.onclick = () => {
  muteState = !muteState;
  const roomId = localStorage.getItem("roomId");
  if(!roomId){ alert("Ch∆∞a k·∫øt n·ªëi Room!"); return; }
  set(commandRef, { mute: muteState, roomId });
  muteBtn.textContent = muteState ? "üîä B·∫≠t √¢m thanh" : "üîá T·∫Øt √¢m thanh";
};

volumeSlider.oninput = () => {
  const roomId = localStorage.getItem("roomId");
  if(!roomId){ alert("Ch∆∞a k·∫øt n·ªëi Room!"); return; }
  set(commandRef, { volume: Number(volumeSlider.value), roomId });
};

// --- K·∫øt n·ªëi Room ---
connectBtn.onclick = () => {
  let room = prompt("Nh·∫≠p Room ID (6 s·ªë) ƒë·ªÉ k·∫øt n·ªëi:");
  if(!room || !/^\d{6}$/.test(room)){
    alert("Ph·∫£i nh·∫≠p ƒë√∫ng Room ID 6 s·ªë!");
    return;
  }
  localStorage.setItem("roomId", room);
  set(connectionRef, { connected: true, roomId: room }).then(()=>{
    alert("‚úÖ ƒê√£ k·∫øt n·ªëi Room: " + room);
  });
};

// --- Ng·∫Øt k·∫øt n·ªëi ---
disconnectBtn.onclick = () => {
  const room = localStorage.getItem("roomId");
  if(!room){
    alert("Ch∆∞a c√≥ Room n√†o k·∫øt n·ªëi!");
    return;
  }
  set(connectionRef, { connected: false, roomId: "" }).then(()=>{
    localStorage.removeItem("roomId");
    alert("‚ùå ƒê√£ ng·∫Øt k·∫øt n·ªëi Room: " + room);
  }).catch(err=>{
    console.error(err);
    alert("‚ö†Ô∏è L·ªói khi ng·∫Øt k·∫øt n·ªëi!");
  });
};

// --- C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI T·ª™ SCREEN ---
onValue(commandRef, snapshot => {
  const cmd = snapshot.val();
  if (!cmd) return;
  muteBtn.textContent = cmd.mute ? "üîä B·∫≠t √¢m thanh" : "üîá T·∫Øt √¢m thanh";
  volumeSlider.value = cmd.volume ?? 100;
});
</script>
</body>
</html>
