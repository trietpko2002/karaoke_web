<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Karaoke Remote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { margin:0; font-family:sans-serif; background:#fff; color:#ff3b3f; display:flex; flex-direction:column; height:100vh; }
#topBar{ display:flex; justify-content:flex-end; align-items:center; gap:15px; padding:10px 20px; border-bottom:2px solid #ff3b3f; font-weight:bold; }
#topBar button{ background:#ff3b3f; color:#fff; border:none; padding:6px 12px; cursor:pointer; border-radius:4px; font-weight:bold; transition:0.2s; }
#topBar button:hover{ background:#e52a2f; }
#left{ flex:1; padding:20px; overflow-y:auto; }
h2{ margin-bottom:15px; color:#ff3b3f; border-bottom:2px solid #ff3b3f; padding-bottom:5px; }
.search-bar{ display:flex; margin-bottom:10px; flex-wrap:wrap; gap:5px; }
input{ flex:1; padding:10px; border:2px solid #ff3b3f; border-radius:5px; font-size:16px; outline:none; }
button.searchBtn, .search-bar button{ padding:10px 14px; border:none; background:#ff3b3f; color:white; border-radius:5px; cursor:pointer; font-weight:bold; }
button.searchBtn:hover{ background:#e52a2f; }
#status{ margin-top:10px; font-size:0.9em; }
.controls{ display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; }
.controls button{ flex:1; border-radius:6px; font-size:15px; border:none; background:#ff3b3f; color:#fff; cursor:pointer; }
.controls button:hover{ background:#e52a2f; }
#volumeSlider{ flex:2; margin-top:10px; }
.item{ display:flex; align-items:center; margin-top:10px; background:#ffecec; color:#ff3b3f; padding:8px; border-radius:6px; cursor:pointer; transition:0.2s; }
.item:hover{ background:#ffd6d6; }
.item img{ width:80px; height:60px; object-fit:cover; margin-right:12px; border-radius:6px; }
.title{ font-size:0.95em; line-height:1.2em; flex:1; color:#ff3b3f; }
</style>
</head>
<body>

<div id="topBar">
  <div id="dateTime"></div>
  <div>Ver Web: 2.4</div>
  <button id="refreshBtn">ğŸ”„ Refresh</button>
</div>

<div id="left">
  <h2>ğŸ¤ TÃ¬m bÃ i hÃ¡t</h2>
  <div class="search-bar">
    <input id="q" placeholder="Nháº­p tá»« khÃ³a..." />
    <button class="searchBtn" id="searchBtn">ğŸ”</button>
    <button id="resetScreenBtn">ğŸ”„ Khá»Ÿi Ä‘á»™ng láº¡i mÃ n hÃ¬nh</button>
  </div>
  <div style="margin-top:10px;">
    <input type="checkbox" id="karaokeOnly" checked />
    <label for="karaokeOnly">Chá»‰ Karaoke</label>
  </div>
  <div id="status"></div>
  <div id="list"></div>

  <div class="controls">
    <button id="muteBtn">ğŸ”‡ Táº¯t/Báº­t Ã¢m thanh</button>
    <input type="range" min="0" max="100" value="100" id="volumeSlider">
    <button id="connectBtn">ğŸ”— Káº¿t ná»‘i Room</button>
    <button id="disconnectBtn">âŒ Ngáº¯t káº¿t ná»‘i</button>
    <button id="resetBtn">â™»ï¸ Reset sá»‘ bÃ i</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = { 
  apiKey: "AIzaSyC1JW_dg-YChaizarbS-7UUN3njFomMPvI",
  authDomain: "karaokeweb-d414b.firebaseapp.com",
  databaseURL: "https://karaokeweb-d414b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "karaokeweb-d414b",
  storageBucket: "karaokeweb-d414b.appspot.com",
  messagingSenderId: "183555717781",
  appId: "1:183555717781:web:d3920b342c5d27e107f99c",
  measurementId: "G-VZ228HB7GF"
};
const API_KEY = "AIzaSyALYcXF9pG01RbeCx6DaZADNwNro2NKq4I";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const commandRef = ref(db,"command");
const connectionRef = ref(db,"connectionStatus");
const resetRef = ref(db,"resetScreen");

const qInput=document.getElementById("q");
const searchBtn=document.getElementById("searchBtn");
const resetScreenBtn=document.getElementById("resetScreenBtn");
const listEl=document.getElementById("list");
const statusEl=document.getElementById("status");
const muteBtn=document.getElementById("muteBtn");
const volumeSlider=document.getElementById("volumeSlider");
const connectBtn=document.getElementById("connectBtn");
const disconnectBtn=document.getElementById("disconnectBtn");
const resetBtn=document.getElementById("resetBtn");

let roomId = localStorage.getItem("roomId") || Math.floor(100000 + Math.random()*900000).toString();
localStorage.setItem("roomId", roomId);

// DateTime
const dateTimeEl=document.getElementById("dateTime");
setInterval(()=>{ dateTimeEl.textContent=new Date().toLocaleString(); },1000);

// Search
async function search(){
  const q=qInput.value.trim();
  const karaokeOnly=document.getElementById("karaokeOnly").checked;
  if(!q) return alert("Nháº­p tá»« khÃ³a!");

  listEl.innerHTML=""; 
  statusEl.textContent="ğŸ” Äang tÃ¬m kiáº¿m...";

  const res=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=12&q=${encodeURIComponent(q+(karaokeOnly?" karaoke":""))}&key=${API_KEY}`);
  const data=await res.json();

  statusEl.textContent="";

  if(!data.items?.length){
    statusEl.textContent="KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£.";
    return;
  }

  data.items.forEach(v=>{
    if(!v.id?.videoId) return;
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <img src="${v.snippet.thumbnails.medium.url}">
      <div class="title">${v.snippet.title}</div>
    `;
    el.onclick=()=>{

      update(commandRef,{
        id:v.id.videoId,
        title:v.snippet.title,
        roomId:roomId
      });

      statusEl.textContent=`â–¶ï¸ Äang phÃ¡t: ${v.snippet.title}`;
    };
    listEl.appendChild(el);
  });
}

searchBtn.onclick=search;

// Reset Screen
resetScreenBtn.onclick=()=>{
  set(resetRef,true);
  statusEl.textContent="ğŸ”„ ÄÃ£ gá»­i lá»‡nh reset screen!";
  setTimeout(()=>set(resetRef,false),2000);
};

// Mute
let muteState=false;
muteBtn.onclick=()=>{
  muteState=!muteState;
  update(commandRef,{mute:muteState, roomId});
  muteBtn.textContent = muteState? "ğŸ”Š Báº­t Ã¢m thanh" : "ğŸ”‡ Táº¯t Ã¢m thanh";
};

// Volume
volumeSlider.oninput=()=>{
  update(commandRef,{
    volume:Number(volumeSlider.value),
    roomId
  });
};

// Connect
connectBtn.onclick=()=>{
  let r=prompt("Nháº­p Room ID:");
  if(r && /^\d{6}$/.test(r)){
    roomId=r;
    localStorage.setItem("roomId",r);
    set(connectionRef,{connected:true, roomId});
    alert("ÄÃ£ káº¿t ná»‘i!");
  }
};

// Disconnect
disconnectBtn.onclick=()=>{
  set(connectionRef,{connected:false, roomId:""});
  alert("ÄÃ£ ngáº¯t káº¿t ná»‘i!");
};

// Reset sá»‘ bÃ i
resetBtn.onclick=()=>{
  update(commandRef,{resetTotal:true, roomId});
  statusEl.textContent="â™»ï¸ ÄÃ£ reset sá»‘ bÃ i!";
};

// Sync from Screen (mute + volume)
onValue(commandRef,snapshot=>{
  const cmd=snapshot.val();
  if(!cmd) return;
  if(cmd.roomId !== roomId) return;

  if(cmd.mute!==undefined){
    muteState=cmd.mute;
    muteBtn.textContent = muteState? "ğŸ”Š Báº­t Ã¢m thanh" : "ğŸ”‡ Táº¯t Ã¢m thanh";
  }
  if(cmd.volume!==undefined){
    volumeSlider.value = cmd.volume;
  }
});
</script>
</body>
</html>
